name: Build Foundry Release

on:
  release:
    types: [published]

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build release assets
        shell: bash
        run: |
          set -euo pipefail

          TAG="${GITHUB_REF_NAME}"          # e.g. v1.0.2
          VERSION="${TAG#v}"                # -> 1.0.2
          REPO="${GITHUB_REPOSITORY}"       # jolivr/actor-organizer
          ID="actor-organizer"

          # Create a clean staging folder that will become the zip root
          rm -rf dist
          mkdir -p "dist/${ID}"
          rsync -a --delete \
            --exclude ".git" \
            --exclude ".github" \
            --exclude ".history" \
            --exclude "node_modules" \
            --exclude "*.zip" \
            ./ "dist/${ID}/"

          # Patch module.json for this release version + correct URLs
          node - <<'NODE'
          const fs = require("fs");
          const path = "dist/actor-organizer/module.json";
          const tag = process.env.TAG;
          const version = process.env.VERSION;
          const repo = process.env.REPO;

          const manifest = JSON.parse(fs.readFileSync(path, "utf8"));
          manifest.version = version;
          manifest.manifest = `https://github.com/${repo}/releases/latest/download/module.json`;
          manifest.download = `https://github.com/${repo}/releases/download/${tag}/actor-organizer.zip`;

          fs.writeFileSync(path, JSON.stringify(manifest, null, 2));
          console.log("Wrote manifest for", tag);
          NODE
        env:
          TAG: ${{ github.ref_name }}
          VERSION: ${{ github.ref_name }}
          REPO: ${{ github.repository }}

      - name: Zip module
        shell: bash
        run: |
          cd dist
          zip -r actor-organizer.zip actor-organizer

      - name: Upload module.json to release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/actor-organizer/module.json
            dist/actor-organizer.zip
